# ..From autoconf
@SET_MAKE@

VPATH = @srcdir@
abs_top_builddir = @abs_top_builddir@
srcdir = @srcdir@
top_builddir = @top_builddir@
builddir = @builddir@
abs_top_srcdir = @abs_top_srcdir@
subdir = aldor/test

all: really-all

.PRECIOUS: Makefile
Makefile: $(srcdir)/Makefile.in $(top_builddir)/config.status
	@case '$?' in \
	  *config.status*) \
	    cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh;; \
	  *) \
	    echo ' cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ '; \
	    cd $(top_builddir) && $(SHELL) ./config.status $(subdir)/$@ ;; \
	esac;

aldorsrcdir = $(abs_top_srcdir)/aldor/src
aldorexedir = $(abs_top_builddir)/aldor/src
aldortooldir = $(abs_top_builddir)/aldor/subcmd/unitools
foamsrclibdir = $(abs_top_srcdir)/aldor/lib/libfoamlib
foamlibdir = $(abs_top_builddir)/aldor/lib/libfoamlib
foamsrcdir = $(abs_top_srcdir)/aldor/lib/libfoam
foamdir = $(abs_top_builddir)/aldor/lib/libfoam

aptests := exquo
fmtests := rectest enumtest clos strtable1 simple apply
ctests  := rectest enumtest multinever maptuple
otests  := enumtest
xtests := enumtest
@BUILD_JAVA_TRUE@jruntests := jimport

x_extra := rtexns

@BUILD_JAVA_TRUE@jtests  := simple_j enumtest run_j

simple_j_AXLFLAGS=-Q2

badtests := opt1

jimport_opts := -Q3
# opt1 fails because the optimise decides to inline the recursive call
# (it shouldn't, but spotting the call is a bit tricky).

opt1_AXLFLAGS=-Y$(foamdir)/al -I $(foamsrcdir)/al -lRuntimeLib=foam -Q9
strtable1_AXLFLAGS=-Y$(foamdir)/al -I $(foamsrcdir)/al -lRuntimeLib=foam -Q9
clos_AXLFLAGS := -Q2
simple_AXLFLAGS=-Fasy -WD+syme -O
multinever_AXLFLAGS = -Q9

_aptests := $(sort $(aptests))
_ctests  := $(sort $(ctests)  $(otests))

_jruntests := $(sort $(jruntests))
_jtests  := $(sort $(jtests) $(_jruntests))
_xtests  := $(sort $(xtests))
_fmtests := $(sort $(fmtests) $(_jtests) $(_ctests))
_otests  := $(sort $(otests) $(x_extra))
_ctests  := $(sort $(ctests)  $(_otests))
_aotests := $(sort $(_fmtests) $(_ctests) $(_xtests))

nfile := -Nfile=$(aldorsrcdir)/aldor.conf

$(patsubst %, out/fm/%.fm, $(_fmtests)): out/fm/%.fm: out/ao/%.ao
	mkdir -p $$(dirname $@)
	$(aldorexedir)/aldor $(nfile) -Ffm=$(builddir)/$@ $<

$(patsubst %, out/c/%.c, $(_ctests)): out/c/%.c: out/ao/%.ao
	mkdir -p $$(dirname $@)
	$(aldorexedir)/aldor $(nfile) -Fc=$(builddir)/$@ $<

$(patsubst %, out/java/%.java, $(_jtests)): $(aldorexedir)/javagen
$(patsubst %, out/java/%.java, $(_jtests)): out/java/%.java: out/fm/%.fm
	mkdir -p $$(dirname $@)
	$(DBG_J) $(aldorexedir)/aldor $(nfile) \
		$(if $(filter $(_jruntests), $*), -Jmain,) \
		-Fjava=$(builddir)/$@ $<

javaopts=-cp $(abs_top_builddir)/aldor/lib/java/src/foamj.jar

$(patsubst %, out/java/%.class, $(_jtests)): out/java/%.class: out/java/%.java
	(cd $(builddir)/out/java; javac $(javaopts) $*.java)

# Create .o files locally as unicl creates files in the
# current directory...
$(patsubst %, %.o, $(_otests)): %.o: out/ao/%.ao
	mkdir -p $$(dirname $@)
	$(aldorexedir)/aldor $(nfile) 	\
			      -Ccc=$(aldortooldir)/unicl	\
			      -Cargs="-Wconfig=$(aldorsrcdir)/aldor.conf $(UNICLFLAGS) -I$(aldorsrcdir)" \
			      -Fo=$(builddir)/$@ $<

$(patsubst %, out/ap/%.ap, $(_aptests)): out/ap/%.ap: $(srcdir)/%.as
	mkdir -p $$(dirname $@)
	$(DBG) $(aldorexedir)/aldor $(nfile) -I$(foamsrclibdir)/al \
			      -Fap=$(builddir)/$@ $<

define aldor_args
	$(nfile) 		\
	-Wcheck			\
	-Y$(foamlibdir)/al	\
	-I$(foamsrclibdir)/al	\
	-lAxlLib=foamlib 		\
	$(AXLFLAGS) $($*_AXLFLAGS)	\
	-Fao=out/ao/$*.ao $(srcdir)/$*.as
endef

$(patsubst %, out/ap/%.ap, $(_aotests)): out/ap/%.ap: %.as
	mkdir -p $$(dirname $@)
	$(aldorexedir)/aldor $(nfile) -Fap=$@ $(srcdir)/$*.as

$(patsubst %, out/ao/%.ao, $(_aotests)): out/ao/%.ao: %.as
	mkdir -p $$(dirname $@)
	$(DBG) $(aldorexedir)/aldor $($*_opts) $(aldor_args)

$(patsubst %, out/ao/%.cmd, $(_aotests)): out/ao/%.cmd: %.as
	mkdir -p $$(dirname $@)
	echo run '$(aldor_args)' > $@

$(patsubst %, %.exe, $(_xtests)): %.exe: %.o rtexns.o
	rm -f $@
	$(DBG) $(aldorexedir)/aldor $(nfile) 		\
		      -Ccc=$(aldortooldir)/unicl	\
		      -Y$(foamdir)			\
		      -Y$(foamlibdir)			\
		      -Lfoamlib				\
		      -Cargs="-Wconfig=$(aldorsrcdir)/aldor.conf -I$(aldorsrcdir) -Wv=2 $(UNICLFLAGS)" \
		      -Fx=$@ out/ao/$*.ao rtexns.o

#		      -Fmain=bobthebuilder.c		\

$(patsubst %, %-javatest,$(_jruntests)): %-javatest: out/java/%.class
	java -cp out/java:$(abs_top_builddir)/aldor/lib/java/src/foamj.jar:$(abs_top_builddir)/aldor/lib/libfoam/al/foam.jar:$(abs_top_builddir)/aldor/lib/libfoamlib/al/foamlib.jar: $*

check-java: $(patsubst %,%-javatest,$(_jruntests))

.PHONY: check-java

check: check-java

really-all: \
     $(patsubst %,out/ap/%.ap,$(_aptests)) \
     $(patsubst %,out/ao/%.cmd,$(_aotests)) \
     $(patsubst %,out/fm/%.fm,$(_fmtests)) \
     $(patsubst %,out/c/%.c,$(_ctests)) \
     $(patsubst %,out/java/%.java,$(_jtests)) \
     $(patsubst %,out/java/%.class,$(_jtests)) \
     $(patsubst %,out/java/%.class,$(_jruntests)) \
     $(patsubst %,%.o,$(_otests))  \
     $(patsubst %,%.exe,$(_xtests))


.PHONY: all

# 
# :: Automake requires this little lot
#
mostlyclean: 
	rm -rf $(builddir)/out
	rm -f $(patsubst %,%.o,$(otests))

clean: mostlyclean
distclean: clean 
	rm Makefile
maintainer-clean: distclean


EMPTY_AUTOMAKE_TARGETS  = dvi pdf ps info html tags ctags
EMPTY_AUTOMAKE_TARGETS += install install-data install-exec uninstall
EMPTY_AUTOMAKE_TARGETS += install-dvi install-html install-info install-ps install-pdf
EMPTY_AUTOMAKE_TARGETS += installdirs
EMPTY_AUTOMAKE_TARGETS += check installcheck

.PHONY: $(EMPTY_AUTOMAKE_TARGETS)
$(EMPTY_AUTOMAKE_TARGETS):
